<script>
// Theme Extension Message Handler - Ana Store ƒ∞√ßin
console.log('üéß Theme store message listener loading...');

document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Setting up Theme Extension message handler in main store');
    
    // Theme Extension'dan gelen mesajlarƒ± dinle
    window.addEventListener('message', function(event) {
        console.log('üì® Store received message:', event.data);
        
        if (event.data.type === 'CUSTOM_CONFIGURATOR_ADD_TO_CART') {
         // Sepet fiyat g√ºncelleyici
document.addEventListener('DOMContentLoaded', function() {
  if (!window.location.pathname.includes('/cart')) {
    return;
  }eConfiguratorAddToCart(event.data.data);
        }
    });
    
    async function handleConfiguratorAddToCart(config) {
        console.log('üõí Handling configurator add to cart in main store:', config);
        
        try {
            // Ana √ºr√ºn√ºn variant ID'sini al
            const productData = {{ product | json }};
            const firstVariantId = productData.variants[0].id;
            
            console.log('Product data:', productData);
            console.log('Using variant ID:', firstVariantId);
            console.log('Calculated price:', config.price);
            
            // √ñNCELƒ∞KLE: Ana sayfadaki fiyatƒ± g√ºncelle
            updateMainProductPrice(config.price);
            
            // Shopify Cart API - doƒüru format (FormData)
            const formData = new FormData();
            formData.append('id', firstVariantId);
            formData.append('quantity', '1');
            
            // √ñNEMLƒ∞: Fiyatƒ± properties olarak ekle
            formData.append('properties[Y√ºkseklik]', config.height + ' cm');
            formData.append('properties[Geni≈ülik]', config.width + ' cm');
            formData.append('properties[Materyal]', config.material);
            formData.append('properties[Hesaplanan Fiyat]', config.price + '‚Ç∫');
            formData.append('properties[Alan]', config.area + ' m¬≤');
            formData.append('properties[√ñzel √úr√ºn]', 'Konfig√ºrat√∂r ile olu≈üturuldu');
            formData.append('properties[Olu≈üturma Zamanƒ±]', new Date().toLocaleString('tr-TR'));
            
            console.log('Adding to cart with calculated price:', config.price);
            
            const response = await fetch('/cart/add.js', {
                method: 'POST',
                body: formData
            });
            
            console.log('Cart API response status:', response.status);
            
            if (response.ok) {
                const cartData = await response.json();
                console.log('‚úÖ Added to cart successfully:', cartData);
                
                // Sepete eklendikten sonra fiyat g√ºncellemesi yap
                await updateCartItemPrice(cartData.key, config.price);
                
                // Sepet sayfasƒ±na y√∂nlendir
                window.location.href = '/cart';
            } else {
                console.warn('‚ö†Ô∏è Cart API failed, redirecting anyway');
                window.location.href = '/cart';
            }
            
        } catch (error) {
            console.error('‚ùå Store message handler error:', error);
            alert('Sepete ekleme hatasƒ±: ' + error.message);
        }
    }
    
    // Ana √ºr√ºn fiyatƒ±nƒ± g√ºncelle
    function updateMainProductPrice(newPrice) {
        console.log('üí∞ Updating main product price to:', newPrice);
        
        // Fiyat elementlerini bul ve g√ºncelle
        const priceSelectors = [
            '.price',
            '.product-price',
            '.price__current',
            '.money',
            '[data-product-price]',
            '.product__price',
            '.price-item--current'
        ];
        
        priceSelectors.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(element => {
                if (element && element.textContent.includes('‚Ç∫') || element.textContent.includes('TL')) {
                    element.textContent = newPrice + '‚Ç∫';
                    element.setAttribute('data-original-price', element.textContent);
                    console.log('Updated price element:', selector, 'to:', newPrice + '‚Ç∫');
                }
            });
        });
        
        // Meta tag'leri de g√ºncelle (sosyal medya payla≈üƒ±mlarƒ± i√ßin)
        updateMetaTags(newPrice);
    }
    
    // Meta tag'leri g√ºncelle
    function updateMetaTags(price) {
        const productPrice = price + '.00';
        
        // Open Graph ve Twitter Card meta tag'lerini g√ºncelle
        const metaSelectors = [
            'meta[property="product:price:amount"]',
            'meta[property="og:price:amount"]',
            'meta[name="twitter:data1"]'
        ];
        
        metaSelectors.forEach(selector => {
            const meta = document.querySelector(selector);
            if (meta) {
                meta.setAttribute('content', productPrice);
            }
        });
    }
    
    // Sepet item fiyatƒ±nƒ± g√ºncelle (AJAX ile)
    async function updateCartItemPrice(itemKey, newPrice) {
        console.log('üõí Updating cart item price:', itemKey, newPrice);
        
        try {
            // Shopify Cart Update API kullan
            const updateData = {
                updates: {},
                attributes: {
                    'custom_price_' + itemKey: newPrice + '‚Ç∫'
                }
            };
            
            const response = await fetch('/cart/update.js', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            });
            
            if (response.ok) {
                console.log('‚úÖ Cart item price updated successfully');
            } else {
                console.warn('‚ö†Ô∏è Cart price update failed, but item was added');
            }
            
        } catch (error) {
            console.warn('‚ö†Ô∏è Cart price update error:', error);
        }
    }
                window.location.href = '/cart';
            } else {
                // Cart API hatasƒ± - sadece redirect yap
                console.warn('‚ö†Ô∏è Cart API failed, redirecting anyway');
                window.location.href = '/cart';
            }
            
        } catch (error) {
            console.error('‚ùå Store message handler error:', error);
            alert('Baƒülantƒ± hatasƒ±: ' + error.message);
        }
    }
    
    console.log('‚úÖ Theme Extension message handler ready in main store');
});
</script>

<div id="block-{{ block.id }}" class="custom-product-configurator">
  <h3>{{ block.settings.title | default: "√ñzel √úr√ºn Konfig√ºrat√∂r√º" }}</h3>
  
  <form class="configurator-form">
    <div class="form-group">
      <label for="height-{{ block.id }}">Boy (cm):</label>
      <input type="number" id="height-{{ block.id }}" min="10" max="500" step="1" required>
    </div>
    
    <div class="form-group">
      <label for="width-{{ block.id }}">En (cm):</label>
      <input type="number" id="width-{{ block.id }}" min="10" max="500" step="1" required>
    </div>
    
    <div class="form-group">
      <label for="material-{{ block.id }}">Materyal:</label>
      <select id="material-{{ block.id }}" required>
        <option value="">Se√ßiniz...</option>
        <option value="wood">Ah≈üap - 25‚Ç∫/m¬≤</option>
        <option value="metal">Metal - 35‚Ç∫/m¬≤</option>
        <option value="pvc">PVC - 20‚Ç∫/m¬≤</option>
        <option value="glass">Cam - 45‚Ç∫/m¬≤</option>
      </select>
    </div>
  </form>
  
  <div class="price-display">
    <p><strong>Tahmini Fiyat: <span class="price">0‚Ç∫</span></strong></p>
    <p><small>Alan: <span class="area-info">0 m¬≤</span> | Materyal: <span class="material-info">Se√ßilmedi</span></small></p>
  </div>
  
  <button class="add-to-cart-btn" disabled>Sepete Ekle</button>
</div>

<style>
.custom-product-configurator {
  background: #f9f9f9;
  padding: 20px;
  border-radius: 8px;
  margin: 20px 0;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  font-weight: bold;
  margin-bottom: 5px;
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.price-display {
  background: linear-gradient(135deg, #e8f4fd 0%, #f0f8ff 100%);
  padding: 20px;
  border-radius: 8px;
  margin: 20px 0;
  border: 2px solid #b3d7ff;
  text-align: center;
  transition: all 0.3s ease;
}

.price-display:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 91, 211, 0.15);
}

.price {
  font-size: 1.4em;
  font-weight: bold;
  color: #005bd3;
}

.area-info, .material-info {
  color: #666;
  font-weight: 500;
}

.add-to-cart-btn {
  background: #008060;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 4px;
  cursor: pointer;
  width: 100%;
}

.add-to-cart-btn:disabled {
  background: #ccc;
  cursor: not-allowed;
}

/* Mevcut varyant se√ßiciyi gizle */
.product-form__variants,
.variant-picker,
[data-option-selector] {
  display: none !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Block-specific element se√ßiciler
  const blockId = '{{ block.id }}';
  const height = document.getElementById('height-' + blockId);
  const width = document.getElementById('width-' + blockId);
  const material = document.getElementById('material-' + blockId);
  const priceDisplay = document.querySelector('#block-' + blockId + ' .price-display');
  const priceSpan = document.querySelector('#block-' + blockId + ' .price');
  const areaSpan = document.querySelector('#block-' + blockId + ' .area-info');
  const materialInfoSpan = document.querySelector('#block-' + blockId + ' .material-info');
  const addBtn = document.querySelector('#block-' + blockId + ' .add-to-cart-btn');
  
  function calculatePrice() {
    const h = parseInt(height?.value || 0);
    const w = parseInt(width?.value || 0);
    const mat = material?.value;
    
    // Alan hesaplama (her zaman g√∂ster)
    const area = (h * w) / 10000; // cm¬≤ to m¬≤
    
    // Materyal bilgisi g√ºncelle
    const materialNames = { 
      wood: 'Ah≈üap (25‚Ç∫/m¬≤)', 
      metal: 'Metal (35‚Ç∫/m¬≤)', 
      pvc: 'PVC (20‚Ç∫/m¬≤)', 
      glass: 'Cam (45‚Ç∫/m¬≤)' 
    };
    
    if (materialInfoSpan) {
      materialInfoSpan.textContent = mat ? materialNames[mat] : 'Se√ßilmedi';
    }
    
    // Alan bilgisi her zaman g√∂ster
    if (areaSpan) {
      if (h > 0 && w > 0) {
        areaSpan.textContent = area.toFixed(4) + ' m¬≤';
      } else {
        areaSpan.textContent = '0 m¬≤';
      }
    }
    
    // Fiyat hesaplama
    if (h > 0 && w > 0 && mat) {
      // T√ºm deƒüerler ge√ßerli - fiyat hesapla
      const prices = { wood: 25, metal: 35, pvc: 20, glass: 45 };
      const materialPrice = prices[mat] || 0;
      
      // Alan katsayƒ±sƒ± (Task 7 - tam backend ile uyumlu)
      let areaMultiplier = 1.0;
      if (area < 0.1) areaMultiplier = 1.5;        // 0-0.1 m¬≤ (k√º√ß√ºk)
      else if (area < 0.5) areaMultiplier = 1.2;   // 0.1-0.5 m¬≤ (orta)
      else if (area < 2) areaMultiplier = 1.0;     // 0.5-2 m¬≤ (standart)
      else if (area < 5) areaMultiplier = 0.9;     // 2-5 m¬≤ (b√ºy√ºk)
      else areaMultiplier = 0.8;                   // 5+ m¬≤ (√ßok b√ºy√ºk)
      
      // Toplam fiyat = Alan √ó Materyal fiyatƒ± √ó Alan katsayƒ±sƒ±
      const totalPrice = area * materialPrice * areaMultiplier;
      
      console.log('Full calculation:', { area, materialPrice, totalPrice });
      
      if (priceSpan) {
        priceSpan.textContent = totalPrice.toFixed(2) + '‚Ç∫';
      }
      if (addBtn) {
        addBtn.disabled = false;
      }
      
      console.log('Price updated to:', totalPrice.toFixed(2) + '‚Ç∫');
      
      // √ñNEMLƒ∞: Ana sayfadaki √ºr√ºn fiyatƒ±nƒ± da g√ºncelle!
      updateMainProductPriceFromConfigurator(totalPrice.toFixed(0));
      
    } else if (h > 0 && w > 0 && !mat) {
      // Boy ve en var ama materyal yok
      if (priceSpan) {
        priceSpan.textContent = 'Materyal se√ßin';
      }
      if (addBtn) {
        addBtn.disabled = true;
      }
      
      // Fiyat belirsizken ana fiyatƒ± sƒ±fƒ±rla
      resetMainProductPrice();
      
    } else if (mat && (!h || !w || h <= 0 || w <= 0)) {
      // Materyal var ama √∂l√ß√ºler eksik
      if (priceSpan) {
        priceSpan.textContent = 'Boy ve En girin';
      }
      if (addBtn) {
        addBtn.disabled = true;
      }
      
    } else {
      // Hi√ßbir ≈üey girilmemi≈ü
      if (priceSpan) {
        priceSpan.textContent = 'Deƒüerleri girin';
      }
      if (addBtn) {
        addBtn.disabled = true;
      }
    }
  }
  
  // Event listeners
  if (height) {
    height.addEventListener('input', function() {
      console.log('Height changed:', this.value);
      calculatePrice();
    });
  }
  
  if (width) {
    width.addEventListener('input', function() {
      console.log('Width changed:', this.value);
      calculatePrice();
    });
  }
  
  if (material) {
    material.addEventListener('change', function() {
      console.log('Material changed:', this.value);
      calculatePrice();
    });
  }
  
  if (addBtn) {
    addBtn.addEventListener('click', function() {
      
      // Konfig√ºrasyon objesi olu≈ütur - hesaplanan fiyatla
      const area = ((height?.value || 0) * (width?.value || 0)) / 10000; // m¬≤ cinsinden
      const materialPrice = material?.value ? { wood: 25, metal: 35, pvc: 20, glass: 45 }[material.value] : 0;
      
      // Alan katsayƒ±sƒ± hesapla
      let areaMultiplier = 1.0;
      if (area < 0.1) areaMultiplier = 1.5;
      else if (area < 0.5) areaMultiplier = 1.2;
      else if (area < 2) areaMultiplier = 1.0;
      else if (area < 5) areaMultiplier = 0.9;
      else areaMultiplier = 0.8;
      
      // Hesaplanan fiyat
      const calculatedPrice = area * materialPrice * areaMultiplier;
      
      const config = {
        height: height?.value,
        width: width?.value,
        material: material?.value,
        area: area.toFixed(4),
        price: calculatedPrice.toFixed(0), // Tam sayƒ± olarak
        priceText: calculatedPrice.toFixed(0) + '‚Ç∫',
        materialText: material?.selectedOptions[0]?.textContent || 'Bilinmiyor',
        productId: '{{ product.id | default: "unknown" }}'
      };
      
      console.log('Sending config:', config);
      
      // Loading state
      const originalText = addBtn.textContent;
      addBtn.textContent = 'Ekleniyor...';
      addBtn.disabled = true;
      
      // Theme App Extension -> Ana App mesaj g√∂nder
      console.log('üì® Sending message to parent app:', config);
      
      // SADECE postMessage kullan - API call yapma!
      console.log('üì® Sending postMessage to parent window');
      
      // Ana store'a mesaj g√∂nder (her durumda)
      window.postMessage({
        type: 'CUSTOM_CONFIGURATOR_ADD_TO_CART',
        data: config,
        source: 'theme-app-extension'
      }, '*');
      
      // Ba≈üarƒ± mesajƒ± g√∂ster ve sepete y√∂nlendir
      addBtn.textContent = 'Eklendi! Sepete gidiliyor...';
      setTimeout(() => {
        window.location.href = '/cart';
      }, 2000);
      
      return; // Sadece postMessage kullan, API call yok!
    });
  }
  
  // ƒ∞lk hesaplama
  setTimeout(calculatePrice, 100);
});

// Ana sayfa fiyat g√ºncelleme fonksiyonlarƒ±
function updateMainProductPriceFromConfigurator(newPrice) {
  // Ana √ºr√ºn fiyat elementlerini bul ve g√ºncelle
  const priceSelectors = [
    '.price',
    '.product-price', 
    '.price__current',
    '.money',
    '[data-product-price]',
    '.product__price',
    '.price-item--current',
    '.product-form__price',
    '.product__price .money'
  ];
  
  let updated = false;
  
  priceSelectors.forEach(selector => {
    const elements = document.querySelectorAll(selector);
    elements.forEach(element => {
      if (element && (element.textContent.includes('‚Ç∫') || element.textContent.includes('TL') || element.textContent.includes('100'))) {
        // Orijinal fiyatƒ± sakla
        if (!element.getAttribute('data-original-price')) {
          element.setAttribute('data-original-price', element.textContent);
        }
        
        element.textContent = newPrice + '‚Ç∫';
        element.style.color = '#e74c3c';
        element.style.fontWeight = 'bold';
        updated = true;
      }
    });
  });
}

function resetMainProductPrice() {
  const priceElements = document.querySelectorAll('[data-original-price]');
  priceElements.forEach(element => {
    const originalPrice = element.getAttribute('data-original-price');
    if (originalPrice) {
      element.textContent = originalPrice;
      element.style.color = '';
      element.style.fontWeight = '';
    }
  });
}

// Theme Extension Ready - Simple postMessage approach
</script>

<!-- Sepet fiyat g√ºncelleyici script -->
<script>
// Sepet sayfasƒ± i√ßin fiyat g√ºncelleyici
document.addEventListener('DOMContentLoaded', function() {
  console.log('üõí Cart price updater loaded');
  
  // Sepet sayfasƒ±nda mƒ± kontrol et
  if (!window.location.pathname.includes('/cart')) {
    return;
  }
  
  updateCartTotals();
  
  // Quantity deƒüi≈üikliklerini dinle
  const quantityInputs = document.querySelectorAll('input[name="updates[]"], .cart-item__quantity input');
  quantityInputs.forEach(input => {
    input.addEventListener('change', () => {
      setTimeout(updateCartTotals, 500);
    });
  });
});

function updateCartTotals() {
  console.log('üí∞ Updating cart totals...');
  
  let totalCalculated = 0;
  
  // Her sepet item'ƒ±nƒ± kontrol et
  const cartItems = document.querySelectorAll('[data-cart-item], .cart-item, .cart__item');
  
  cartItems.forEach((item, index) => {
    console.log('üîç Processing cart item:', index);
    
    // Quantity bul
    const quantityInput = item.querySelector('input[name="updates[]"], .cart-item__quantity input, input[type="number"]');
    const quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;
    
    // Properties i√ßinde hesaplanan fiyatƒ± ara
    const properties = item.querySelectorAll('p, span, div');
    let calculatedPrice = null;
    
    properties.forEach(prop => {
      const text = prop.textContent || '';
      
      // "Fiyat: 400.00‚Ç∫" formatƒ±nƒ± ara
      if (text.includes('Fiyat:') && (text.includes('‚Ç∫') || text.includes('TL'))) {
        const priceMatch = text.match(/Fiyat:\s*([0-9]+(?:\.[0-9]+)?)/);
        if (priceMatch) {
          calculatedPrice = parseFloat(priceMatch[1]);
          console.log('üíµ Found calculated price:', calculatedPrice, 'for quantity:', quantity);
        }
      }
    });
    
    if (calculatedPrice) {
      totalCalculated += calculatedPrice * quantity;
      
      // Bu item'ƒ±n toplam fiyatƒ±nƒ± g√ºncelle
      const itemTotalElements = item.querySelectorAll('.cart-item__total, .cart-item__price, .money, [data-cart-item-price]');
      itemTotalElements.forEach(element => {
        if (element.textContent.includes('100.00') || element.textContent.includes('TL') || element.textContent.includes('‚Ç∫')) {
          element.textContent = (calculatedPrice * quantity).toFixed(2) + '‚Ç∫';
          element.style.color = '#e74c3c';
          element.style.fontWeight = 'bold';
        }
      });
    }
  });
  
  if (totalCalculated > 0) {
    console.log('üéØ Total calculated price:', totalCalculated);
    
    // Sepet toplamƒ±nƒ± g√ºncelle
    const totalSelectors = [
      '.cart__total',
      '.cart-total',
      '.totals__total',
      '[data-cart-total]',
      '.cart-subtotal__price',
      '.cart__footer .money',
      '.cart-footer .money'
    ];
    
    totalSelectors.forEach(selector => {
      const elements = document.querySelectorAll(selector);
      elements.forEach(element => {
        if (element && (element.textContent.includes('100.00') || element.textContent.includes('200.00'))) {
          element.textContent = totalCalculated.toFixed(2) + '‚Ç∫';
          element.style.color = '#e74c3c';
          element.style.fontWeight = 'bold';
          
          console.log('‚úÖ Updated total to:', totalCalculated.toFixed(2) + '‚Ç∫');
        }
      });
    });
  }
}

// Checkout butonunu dinle ve fiyat uyarƒ±sƒ± g√∂ster
document.addEventListener('click', function(e) {
  if (e.target.matches('.btn--checkout, [name="add"], .cart__checkout-button, .checkout-button')) {
    console.log('üõí Checkout clicked - prices should be updated');
    
    // Son bir kez fiyatlarƒ± g√ºncelle
    setTimeout(updateCartTotals, 100);
  }
});
</script>

{% schema %}
{
  "name": "√ñzel √úr√ºn Konfig√ºrat√∂r√º",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Ba≈ülƒ±k",
      "default": "√ñzel √úr√ºn Konfig√ºrat√∂r√º"
    }
  ]
}
{% endschema %}